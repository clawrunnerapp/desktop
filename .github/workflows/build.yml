name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      openclaw_ref:
        description: 'OpenClaw version (tag, branch, or commit SHA)'
        required: false
        default: 'v2026.2.13'
      build_macos_arm64:
        description: 'macOS ARM64'
        type: boolean
        default: true
      build_macos_x64:
        description: 'macOS x64'
        type: boolean
        default: true
      build_linux_x64:
        description: 'Linux x64'
        type: boolean
        default: true
      build_windows_x64:
        description: 'Windows x64'
        type: boolean
        default: true

env:
  OPENCLAW_REF: ${{ inputs.openclaw_ref || 'v2026.2.13' }}

permissions:
  contents: write

jobs:
  matrix:
    runs-on: ubuntu-latest
    outputs:
      include: ${{ steps.set.outputs.include }}
    steps:
      - id: set
        uses: actions/github-script@v7
        with:
          script: |
            const platforms = [
              { platform: 'macos-14', target: 'aarch64-apple-darwin', node_platform: 'darwin-arm64', extra_args: '--bundles app,updater', input: 'build_macos_arm64' },
              { platform: 'macos-15-intel', target: 'x86_64-apple-darwin', node_platform: 'darwin-x64', extra_args: '--bundles app,updater', input: 'build_macos_x64' },
              { platform: 'ubuntu-22.04', target: 'x86_64-unknown-linux-gnu', node_platform: 'linux-x64', extra_args: '--bundles deb,rpm,updater', input: 'build_linux_x64' },
              { platform: 'windows-latest', target: 'x86_64-pc-windows-msvc', node_platform: 'win-x64', extra_args: '--bundles nsis,updater', input: 'build_windows_x64' },
            ];

            const isManual = context.eventName === 'workflow_dispatch';
            const inputs = context.payload.inputs || {};

            const filtered = isManual
              ? platforms.filter(p => inputs[p.input] !== 'false')
              : platforms;

            const result = filtered.map(({ input, ...rest }) => rest);
            core.setOutput('include', JSON.stringify(result));

  build:
    needs: matrix
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.matrix.outputs.include) }}

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Clone OpenClaw
        uses: actions/checkout@v4
        with:
          repository: openclaw/openclaw
          ref: ${{ env.OPENCLAW_REF }}
          path: openclaw

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable pnpm via corepack
        run: corepack enable

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libfuse2

      - name: Install frontend dependencies
        run: npm install

      - name: Prepare bundle (Unix)
        if: runner.os != 'Windows'
        run: bash scripts/prepare-bundle.sh
        env:
          OPENCLAW_SRC: ${{ github.workspace }}/openclaw

      - name: Prepare bundle (Windows)
        if: runner.os == 'Windows'
        run: pwsh scripts/prepare-bundle.ps1
        env:
          OPENCLAW_SRC: ${{ github.workspace }}/openclaw

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPIMAGE_EXTRACT_AND_RUN: 1
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "ClawRunner ${{ github.ref_name }}"
          releaseBody: "See the assets for download links."
          releaseDraft: true
          prerelease: false
          args: --target ${{ matrix.target }} ${{ matrix.extra_args }}

      - name: Create DMG (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euo pipefail
          APP_DIR="src-tauri/target/${{ matrix.target }}/release/bundle/macos"
          APP_NAME=$(ls "$APP_DIR" | grep '\.app$' | head -1)

          if [ "${{ matrix.target }}" = "aarch64-apple-darwin" ]; then
            ARCH="aarch64"
          else
            ARCH="x64"
          fi

          VERSION=$(plutil -extract version raw src-tauri/tauri.conf.json)
          DMG_NAME="ClawRunner_${VERSION}_${ARCH}.dmg"

          STAGING=$(mktemp -d)
          cp -R "$APP_DIR/$APP_NAME" "$STAGING/"
          ln -s /Applications "$STAGING/Applications"

          hdiutil create -volname "ClawRunner" -srcfolder "$STAGING" -ov -format UDZO "$APP_DIR/../$DMG_NAME"
          rm -rf "$STAGING"

          echo "Created $DMG_NAME"

      - name: Upload DMG to release (macOS)
        if: runner.os == 'macOS'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DMG_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.dmg" | head -1)
          gh release upload "${{ github.ref_name }}" "$DMG_PATH" --clobber
